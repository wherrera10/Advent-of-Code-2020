using Gtk, Colors, Random

function puzzle16app(bsize)
    win = GtkWindow("16 Game", 300, 300) |> (GtkFrame() |> (box = GtkBox(:v)))
    toolbar = GtkToolbar()
    newgame = GtkToolButton("New Game")
    set_gtk_property!(newgame, :label, "New Game")
    set_gtk_property!(newgame, :is_important, true)
    push!(toolbar, newgame)
    grid = GtkGrid()
    map(w -> push!(box, w),[toolbar, grid])
    buttons = Array{Gtk.GtkButtonLeaf,2}(undef, bsize + 2, bsize + 2)
    for i in 1:bsize+2, j in 1:bsize+2
        grid[i,j] = buttons[i,j] = GtkButton()
        set_gtk_property!(buttons[i,j], :expand, true)
    end

    inorder = string.(reshape(1:bsize*bsize, bsize, bsize))
    shufflepuzzle(puzz) = shuffle(puzz)
    puzzle = shufflepuzzle(inorder)
    idx(siz, row) = siz * (row - 1) + 1 : siz * row
    rotatecol(puzzle, col, n) = puzzle[idx(bsize, col)] .=
        circshift(puzzle[idx(bsize, col)], n)
    rotaterow(puzzle, row, n) = rotl90(rotatecol(rotr90(puzzle), row, n))
    iswon() = puzzle == inorder
    won = false

    function update!()
        aclock, clock = "\u27f2", "\u27f3"
        for i in 1:bsize+2, j in 1:bsize+2
            if 1 < j < bsize + 2
                if i == 1
                    set_gtk_property!(buttons[i, j], :label, clock)
                    signal_connect(playerclicked, buttons[i, j], "clicked")
                elseif i == bsize + 2
                    set_gtk_property!(buttons[i, j], :label, aclock)
                    signal_connect(playerclicked, buttons[i, j], "clicked")
                else
                    set_gtk_property!(buttons[i, j], :label, puzzle[i-1, j-1])
                end
            elseif 1 < i < bsize + 2
                if j == 1
                    set_gtk_property!(buttons[i, j], :label, clock)
                    signal_connect(playerclicked, buttons[i, j], "clicked")
                elseif j == bsize + 2
                    set_gtk_property!(buttons[i, j], :label, aclock)
                    signal_connect(playerclicked, buttons[i, j], "clicked")
                end
            end
        end
        if iswon()
            won = true
            info_dialog("Game over.\nScore: $score")
        end
    end

    function initialize!(w)
        puzzle = shufflepuzzle(inorder)
        won = false
        update!()
    end

    function findrowcol(button)
        for i in 1:bsize+2, j in 1:bsize+2
            if buttons[i, j] == button
                return i, j
            end
        end
        return 0, 0
    end

    function playerclicked(button)
        if !won
            i, j = findrowcol(button)
                if i == 1
                    rotatecol(puzzle, j - 1, 1)
                elseif i == bsize + 2
                    rotatecol(puzzle, j - 1, -1)
                elseif j == 1
                    rotaterow(puzzle, i - 1, 1)
                elseif j == bsize + 2
                    rotatecol(puzzle, j - 1, -1)
                end
            end
        end
        update!()
    end

    condition = Condition()
    endit(w) = notify(condition)
    initialize!(win)
    signal_connect(initialize!, newgame, :clicked)
    signal_connect(endit, win, :destroy)
    showall(win)
    wait(condition)
end


puzzle16app(4)


  
