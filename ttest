abstract type Entry end

mutable struct OutlineEntry <: Entry
    level::Int
    text::String
    parent::Union{Entry, Nothing}
    children::Vector{Entry}
end

mutable struct Outline
    root::OutlineEntry
    entries::Vector{OutlineEntry}
    baseindent::String
end

rootentry() = OutlineEntry(0, "", nothing, [])
indentchar(ch) = ch == ' ' || ch == '\t'
firsttext(s) = something(findfirst(!indentchar, s), length(s) + 1)
splitline(s) = begin i = firsttext(s); i == 1 ? ("", s) : (s[1:i-1], s[i:end]) end

function firstindent(lines, default = "        ")
    for lin in lines
        s1, s2 = splitline(lin)
        s1 != "" && return s1
    end
    return default
end

function Outline(str::String)
    arr, lines = OutlineEntry[], filter(x -> x != "", split(str, r"\r\n|\n|\r"))
    root, indent, parentindex, lastindents = rootentry(), firstindent(lines), 0, 0
    indentlen, indentregex = length(indent), Regex(indent)
    for (i, lin) in enumerate(lines)
        header, txt = splitline(lin)
        indentcount = length(collect(eachmatch(indentregex, header)))
        (indentcount * indentlen < length(header)) && throw("Error: bad indent <$header>")
        if indentcount > lastindents
            parentindex = i > 1 ? i - 1 : 0
        elseif indentcount < lastindents
            parentindex = something(findlast(x -> x.level == indentcount, arr), 0)
        end
        lastindents = indentcount
        ent = OutlineEntry(indentcount, txt, parentindex == 0 ? root : arr[parentindex], [])
        push!(ent.parent.children, ent)
        push!(arr, ent)
    end
    return Outline(root, arr, indent)
end

function sorttree!(ent::OutlineEntry, rev=false)
    sort!(ent.children, lt=(x, y) -> x.text < y.text, rev=rev)
    for child in ent.children
        sorttree!(child, rev)
    end
    return ent
end

sorted(o::Outline, r=false) = (x = deepcopy(o); for e in x.entries sorttree!(e, r); end; x)

println(Outline("""
topic is topical
    A.
        3.
        1.
        2.
        4.
    B.
        2.
        4.
        3.
        1.
    C.
another topic
    c.
    A.
    B.
Done"""))
